<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç™Œç—‡å°ˆç§‘æœƒè­°è­°ç¨‹æµ·å ±è£½ä½œå™¨ï¼ˆå¤šPNGã€å¯èª¿å±¤ç´šã€è§£é–æ¯”ä¾‹ã€è£åˆ‡ï¼‰</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Microsoft JhengHei','Arial',sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
    .container { max-width: 1400px; margin:0 auto; background:#fff; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.3); overflow:hidden; }
    .header { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:30px; text-align:center; }
    .main-content { display:flex; height:800px; }
    .control-panel { width:460px; padding:24px 20px; background:#f8f9fa; overflow-y:auto; border-right:2px solid #e0e0e0; }
    .canvas-container { flex:1; padding:30px; display:flex; flex-direction:column; align-items:center; background:#fff; overflow-y:auto; max-height:800px; }
    canvas { border:2px solid #e0e0e0; box-shadow:0 10px 30px rgba(0,0,0,.1); border-radius:10px; background:#fff; touch-action:none; }
    .section-title { font-size:18px; font-weight:600; color:#333; margin:8px 0 12px; padding-bottom:10px; border-bottom:2px solid #e0e0e0; }
    .form-group { margin-bottom:14px; }
    label { display:block; margin-bottom:8px; font-weight:600; color:#333; font-size:14px; }
    input,select,textarea { width:100%; padding:10px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; transition:all .2s; font-family:'Microsoft JhengHei','Arial',sans-serif; }
    input:focus,select:focus,textarea:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.12); }
    .btn { padding:9px 12px; border:none; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; transition:all .2s; margin:4px 4px; }
    .btn-primary { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; }
    .btn-secondary { background:#6c757d; color:#fff; }
    .btn-danger { background:#dc3545; color:#fff; }
    .btn-ghost { background:#fff; color:#333; border:2px solid #e0e0e0; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex:1; }
    .template-selector { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-bottom:8px; }
    .template-btn { padding:16px; border:3px solid #e0e0e0; border-radius:12px; cursor:pointer; transition:all .2s; text-align:center; background:#fff; }
    .template-btn:hover { border-color:#667eea; transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,.2);} 
    .template-btn.active { border-color:#667eea; background: linear-gradient(135deg, rgba(102,126,234,.08) 0%, rgba(118,75,162,.08) 100%);} 
    .agenda-items { max-height:260px; overflow-y:auto; border:2px solid #e0e0e0; border-radius:8px; padding:12px; background:#fff; }
    .agenda-item { padding:12px; margin-bottom:8px; background:#f8f9fa; border-radius:8px; border-left:4px solid #667eea; position:relative; }
    .agenda-item .controls { position:absolute; top:10px; right:10px; display:flex; gap:6px; }

    /* === Tabs é¢æ¿åˆ†é  === */
    .tabs { display:flex; gap:6px; margin-bottom:12px; }
    .tab-btn { flex:1; padding:10px; border:none; border-radius:8px; cursor:pointer; font-weight:600; background:#e0e0e0; }
    .tab-btn.active { background:#667eea; color:#fff; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }

    /* === PNG åœ–å±¤æ¸…å–® === */
    .overlay-list { max-height:260px; overflow:auto; border:2px solid #e0e0e0; border-radius:8px; background:#fff; }
    .overlay-item { display:flex; align-items:center; gap:8px; padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
    .overlay-item.active { background:#e9f0ff; }
    .overlay-thumb { width:38px; height:38px; border-radius:6px; border:1px solid #ddd; background-size:cover; background-position:center; }
    .overlay-name { flex:1; font-size:12px; color:#333; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .overlay-actions { display:flex; gap:6px; }
    .mini-hint { font-size:12px; color:#666; line-height:1.4; }

    /* === è£åˆ‡è¦–çª— === */
    .cropper-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:9999; }
    .cropper-modal { background:#fff; width:min(92vw, 980px); border-radius:14px; overflow:hidden; box-shadow:0 30px 80px rgba(0,0,0,.4); }
    .cropper-header { padding:14px 16px; background:#111827; color:#fff; font-weight:700; }
    .cropper-body { padding:16px; }
    #cropperCanvas { border:1px solid #e5e7eb; display:block; width:100%; height:auto; background:#fff; }
    .cropper-footer { display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid #eee; }

    /* è‡ªè¨‚é…è‰²å°ˆå€ */
    .custom-colors-section { display:none; margin-top:10px; padding:15px; background:#f8f9fa; border-radius:8px; border:2px solid #e0e0e0; }
    .custom-colors-section.show { display:block; }
    .color-group { margin-bottom:10px; }
    .color-group label { font-size:13px; margin-bottom:4px; }
    .four-color-row { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
    .three-color-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .two-color-row { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; }

    /* å¤šè¡Œè¼¸å…¥æ¡†æ¨£å¼ */
    .multiline-input { min-height:60px; resize:vertical; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ—ï¸ ç™Œç—‡å°ˆç§‘æœƒè­°è­°ç¨‹æµ·å ±è£½ä½œå™¨</h1>
      <p style="margin-top:10px;opacity:.9;">é–‹ç™¼è€…ï¼šTom Ho</p>
    </div>
    <div class="main-content">
      <div class="control-panel">
        <!-- åˆ†é æ¨™ç±¤ -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="tab-content">ğŸ“‹ æœƒè­°å…§å®¹ç·¨è¼¯å€</button>
          <button class="tab-btn" data-tab="tab-style">ğŸ¨ æµ·å ±é¢¨æ ¼è¨­è¨ˆå€</button>
          <button class="tab-btn" data-tab="tab-file">ğŸ“‚ æª”æ¡ˆåŒ¯å…¥èˆ‡åŒ¯å‡ºå€</button>
        </div>
  
        <!-- æœƒè­°å…§å®¹ç·¨è¼¯å€ -->
        <div id="tab-content" class="tab-panel active">
          <h2 class="section-title">ğŸ“‹ åŸºæœ¬è³‡è¨Š</h2>
          <div class="form-group"><label>æœƒè­°æ¨™é¡Œ</label><input id="conferenceTitle" type="text" placeholder="ä¾‹ï¼š2025å¹´åº¦ç™Œç—‡é†«å­¸ç ”è¨æœƒ" /></div>
          <div class="form-group"><label>å‰¯æ¨™é¡Œ</label><input id="conferenceSubtitle" type="text" value="è‚ºç™Œæ²»ç™‚æ–°é€²å±•è«–å£‡" /></div>
          <div class="form-group"><label>æ—¥æœŸ</label><input id="conferenceDate" type="text" placeholder="ä¾‹ï¼š2025å¹´8æœˆ15æ—¥" /></div>
          <div class="form-group"><label>åœ°é»</label><input id="conferenceLocation" type="text" value="å°åŒ—åœ‹éš›æœƒè­°ä¸­å¿ƒ" /></div>
  
          <h2 class="section-title">ğŸ—ï¸ ç™Œç—‡å°ˆç§‘</h2>
          <div class="template-selector">
            <div class="template-btn active" data-template="lung"><div style="font-size:24px;">ğŸ«</div><div>è‚ºç™Œ</div></div>
            <div class="template-btn" data-template="headneck"><div style="font-size:24px;">ğŸ‘¤</div><div>é ­é ¸ç™Œ</div></div>
            <div class="template-btn" data-template="uterus"><div style="font-size:24px;">â™€ï¸</div><div>å­å®®é«”ç™Œ</div></div>
            <div class="template-btn" data-template="urinary"><div style="font-size:24px;">ğŸ©º</div><div>æ³Œå°¿é“ç™Œ</div></div>
            <div class="template-btn" data-template="colorectal"><div style="font-size:24px;">ğŸ©»</div><div>å¤§è…¸ç›´è…¸ç™Œ</div></div>
            <div class="template-btn" data-template="breast"><div style="font-size:24px;">ğŸ—ï¸</div><div>ä¹³ç™Œ</div></div>
          </div>
  
          <h2 class="section-title">ğŸ“… è­°ç¨‹é …ç›®</h2>
          <div class="form-group"><label>æ™‚é–“</label><input id="agendaTime" placeholder="ä¾‹ï¼š09:00-09:30" type="text" /></div>
          <div class="form-group"><label>ä¸»é¡Œï¼ˆå¯æŒ‰Enteræ›è¡Œï¼‰</label><textarea id="agendaTopic" class="multiline-input" placeholder="ä¾‹ï¼šé–‹å¹•è‡´è©"></textarea></div>
          <div class="form-group"><label>è¬›è€…ï¼ˆå¯æŒ‰Enteræ›è¡Œï¼‰</label><textarea id="agendaSpeaker" class="multiline-input" placeholder="ä¾‹ï¼šç‹æ•™æˆ"></textarea></div>
          <div class="form-group"><label>ä¸»æŒäººï¼ˆå¯æŒ‰Enteræ›è¡Œï¼‰</label><textarea id="agendaModerator" class="multiline-input" placeholder="ä¾‹ï¼šæé†«å¸«"></textarea></div>
          <div class="row">
            <button class="btn btn-primary" id="agendaAdd">â• æ–°å¢</button>
            <button class="btn btn-secondary" id="agendaSample">ğŸ“‹ è¼‰å…¥ç¯„ä¾‹</button>
            <button class="btn btn-secondary" id="agendaClear">ğŸ—‘ï¸ æ¸…ç©º</button>
          </div>
          <div id="agendaList" class="agenda-items"></div>
  
          <h2 class="section-title">ğŸ“ é å°¾è¨»è§£</h2>
          <div class="form-group"><label style="display:flex;align-items:center;gap:8px;font-weight:600;"><input type="checkbox" id="showFooterNote" checked style="width:auto;"/>é¡¯ç¤ºé å°¾è¨»è§£</label></div>
          <div class="form-group"><textarea id="footerNoteContent" rows="6" style="resize:vertical;font-size:12px;line-height:1.4;">æœ¬æœƒè­°æ˜¯é†«è—¥å­¸è¡“æœƒè­°,èˆ‡æœƒè€…çš†æ˜¯é†«ç™‚å°ˆæ¥­äººå“¡,çœ·å±¬ä¸é©åˆåƒåŠ ,æœ¬å…¬å¸äº¦ä¸æœƒæ”¯ä»˜çœ·å±¬è²»ç”¨ã€‚æ­¤å¤–,ç‚ºä½¿èˆ‡æœƒé†«ç™‚å°ˆæ¥­äººå“¡äº«æœ‰é«˜è³ªé‡å°ˆæ¥­çš„å­¸è¡“æœƒè­°ã€‚ç•¶éœ€è¦æ™‚,æœ¬å…¬å¸æœƒå®‰æ’ç‰¹ç´„å» å•†åˆ°å ´å”åŠ©æ¥å¾…åŠåšæœƒè­°ç´€éŒ„ã€‚å» å•†èˆ‡é»˜æ²™æ±å…¬å¸ç°½æœ‰æœå‹™ä¿å¯†æ¢æ¬¾,ä¸¦æ‰¿è«¾å» å•†ä»£è¡¨åœ¨åŸ·è¡Œæœå‹™æ™‚,æœƒè­°ä»é †æš¢é€²è¡Œã€‚å¦‚æœ‰ä¸ä¾¿ä¹‹è™•,æ•¬è«‹è¦‹è«’ã€‚</textarea></div>
        </div>
  
        <!-- æµ·å ±é¢¨æ ¼è¨­è¨ˆå€ -->
        <div id="tab-style" class="tab-panel">
          <h2 class="section-title">ğŸ¨ é…è‰²æ–¹æ¡ˆ</h2>
          <div class="row">
            <select id="colorScheme">
              <option value="medical_green">ç¶“å…¸é†«ç™‚ç¶ </option>
              <option value="business_green">å°ˆæ¥­å•†å‹™ç¶ </option>
              <option value="tech_green">ç¾ä»£ç§‘æŠ€ç¶ </option>
              <option value="custom">è‡ªè¨‚é…è‰²</option>
            </select>
            <select id="gradientDir">
              <option value="horizontal">æ°´å¹³</option>
              <option value="vertical">å‚ç›´</option>
              <option value="diagonal">å°è§’</option>
            </select>
          </div>
          <div id="customColorsSection" class="custom-colors-section">
            <div class="color-group">
              <label>ğŸŒŸ æ¨™é¡Œæ¼¸å±¤è‰²å½©ï¼ˆä¸‰è‰²ï¼‰</label>
              <div class="three-color-row">
                <input type="color" id="headerC1" value="#1B4D3E" title="æ¨™é¡Œè‰²1">
                <input type="color" id="headerC2" value="#2D8659" title="æ¨™é¡Œè‰²2">
                <input type="color" id="headerC3" value="#4CAF85" title="æ¨™é¡Œè‰²3">
              </div>
            </div>
            
            <div class="color-group">
              <label>ğŸ“„ è­°ç¨‹å€åŸŸé…è‰²ï¼ˆä¸‰è‰²ï¼‰</label>
              <div class="three-color-row">
                <input type="color" id="agendaBg" value="#E8F5E8" title="è­°ç¨‹èƒŒæ™¯è‰²">
                <input type="color" id="agendaBorder" value="#1B4D3E" title="è­°ç¨‹é‚Šæ¡†è‰²">
                <input type="color" id="agendaAccent" value="#2D8659" title="è­°ç¨‹é‡é»è‰²">
              </div>
            </div>
  
            <div class="color-group">
              <label>ğŸ–¼ï¸ æµ·å ±åº•è‰²æ¼¸å±¤ï¼ˆé›™è‰²ï¼‰</label>
              <div class="two-color-row">
                <input type="color" id="bgC1" value="#ffffff" title="åº•è‰²1">
                <input type="color" id="bgC2" value="#f8f9fa" title="åº•è‰²2">
              </div>
            </div>
            
            <div class="row">
              <label>åº•è‰²æ¼¸å±¤æ–¹å‘</label>
              <select id="bgGradientDir">
                <option value="horizontal">æ°´å¹³</option>
                <option value="vertical">å‚ç›´</option>
                <option value="diagonal">å°è§’</option>
                <option value="radial">æ”¾å°„ç‹€</option>
                <option value="none">ç„¡æ¼¸å±¤</option>
              </select>
            </div>
  
            <button class="btn btn-primary" id="applyCustomColors" style="width:100%; margin-top:10px;">ğŸ¨ å¥—ç”¨è‡ªè¨‚é…è‰²</button>
          </div>
  
          <h2 class="section-title">ğŸ–¼ï¸ PNG åœ–å±¤</h2>
          <div class="form-group">
            <label>é¸æ“‡ PNG æª”ï¼ˆå¯å¤šé¸ï¼Œé€æ˜èƒŒæ™¯æœ€ä½³ï¼‰</label>
            <input id="overlayFile" type="file" accept="image/png" multiple />
            <div class="mini-hint">é»æ“Šæ¸…å–®é¸å–ï¼›æ‹–æ›³ç•«å¸ƒç§»å‹•ï¼›è§’è½ç¸®æ”¾ï¼›ä¸Šæ–¹åœ“é»æ—‹è½‰ã€‚æ”¯æ´å¤šç‰©ä»¶èˆ‡å±¤ç´šèª¿æ•´ã€‚</div>
          </div>
          <div id="overlayList" class="overlay-list" aria-label="PNG åœ–å±¤æ¸…å–®"></div>
          <div class="row" style="margin-top:6px;">
            <button class="btn btn-secondary" id="bringFront">â¬†ï¸ æœ€ä¸Š</button>
            <button class="btn btn-secondary" id="bringForward">ğŸ”¼ ä¸Šç§»</button>
            <button class="btn btn-secondary" id="sendBackward">ğŸ”½ ä¸‹ç§»</button>
            <button class="btn btn-secondary" id="sendBack">â¬‡ï¸ æœ€ä¸‹</button>
          </div>
          <div class="row" style="margin-top:6px;">
            <label style="flex:none;width:88px;">é€æ˜åº¦</label>
            <input id="overlayOpacity" type="range" min="0" max="1" step="0.01" value="1" />
          </div>
          <div class="row" style="margin-top:6px;">
            <label style="display:flex;align-items:center;gap:6px;flex:1;">
              <input id="overlayVisible" type="checkbox" checked style="width:auto;"> é¡¯ç¤º
            </label>
            <label style="display:flex;align-items:center;gap:6px;flex:1;">
              <input id="overlayLockAspect" type="checkbox" checked style="width:auto;"> é–å®šæ¯”ä¾‹
            </label>
          </div>
          <div class="row" style="margin-top:6px;">
            <button class="btn btn-secondary" id="centerOverlay">ç½®ä¸­</button>
            <button class="btn btn-secondary" id="resetOverlay">é‡è¨­å¤§å°/è§’åº¦</button>
            <button class="btn btn-danger" id="removeOverlay">ç§»é™¤</button>
          </div>
          <div class="row" style="margin-top:6px;">
            <button class="btn btn-primary" id="openCropper">âœ‚ï¸ è£åˆ‡</button>
            <button class="btn btn-ghost" id="resetCrop">é‚„åŸè£åˆ‡</button>
          </div>
        </div>
  
        <!-- æª”æ¡ˆåŒ¯å…¥èˆ‡åŒ¯å‡ºå€ -->
        <div id="tab-file" class="tab-panel">
          <h2 class="section-title">ğŸ“‚ åŒ¯å…¥ / åŒ¯å‡ºç‹€æ…‹</h2>
          <div class="row" style="margin-top:6px;">
            <button class="btn btn-secondary" onclick="exportState()">ğŸ“¤ åŒ¯å‡º JSON ç‹€æ…‹</button>
            <button class="btn btn-secondary" onclick="importState()">ğŸ“¥ åŒ¯å…¥ JSON ç‹€æ…‹</button>
          </div>
        </div>
      </div>

      <div class="canvas-container">
        <div class="canvas-area"><canvas id="posterCanvas" width="800" height="600"></canvas></div>
        <div style="display:flex; gap:10px; margin-top:16px; justify-content:center;">
          <button class="btn btn-primary" id="btnUpdate">ğŸ”„ æ›´æ–°æµ·å ±</button>
          <button class="btn btn-secondary" id="btnDownload">ğŸ’¾ ä¸‹è¼‰æµ·å ±</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è£åˆ‡å™¨ Modal -->
  <div id="cropperBackdrop" class="cropper-backdrop">
    <div class="cropper-modal">
      <div class="cropper-header">PNG åœ–å±¤è£åˆ‡</div>
      <div class="cropper-body">
        <canvas id="cropperCanvas" width="900" height="600"></canvas>
        <div class="mini-hint" style="margin-top:8px;">æ‹–æ›³æ¡†ç·šæˆ–è§’é»èª¿æ•´ç¯„åœï¼›æ‹–æ›³æ¡†ä¸­å¿ƒå¯ç§»å‹•æ•´å€‹è£åˆ‡æ¡†ã€‚è£åˆ‡æ¡†ä»¥ã€ŒåŸåœ–åƒç´ ã€è¨ˆç®—ï¼Œå¥—ç”¨å¾Œæœƒå³æ™‚åæ˜ åœ¨å³å´é è¦½ã€‚</div>
      </div>
      <div class="cropper-footer">
        <button class="btn btn-ghost" id="closeCropper">é—œé–‰</button>
        <button class="btn btn-secondary" id="resetCropper">é‡ç½®æ¡†</button>
        <button class="btn btn-primary" id="applyCropper">å¥—ç”¨è£åˆ‡</button>
      </div>
    </div>
  </div>

  <script>
    // ====== å…¨åŸŸç‹€æ…‹ï¼ˆè­°ç¨‹/æ¨£å¼ï¼‰======
    let agendaItems = [];
    let currentTemplate = 'lung';
    let currentColorScheme = 'medical_green';
    let currentGradientDirection = 'horizontal';
    
    // æ“´å±•è‡ªè¨‚é¡è‰²ç‰©ä»¶
    let customColors = { 
      // æ¨™é¡Œå€åŸŸ
      headerC1:'#1B4D3E', headerC2:'#2D8659', headerC3:'#4CAF85',
      // è­°ç¨‹å€åŸŸ  
      agendaBg:'#E8F5E8', agendaBorder:'#1B4D3E', agendaAccent:'#2D8659',
      // æµ·å ±åº•è‰²
      bgC1:'#ffffff', bgC2:'#f8f9fa', bgGradientDir:'none'
    };

    const colorSchemes = {
      medical_green:{ name:'ç¶“å…¸é†«ç™‚ç¶ ', header:{ colors:['#1B4D3E','#2D8659','#4CAF85'], text:'#FFFFFF' }, agenda:{ background:'#E8F5E8', border:'#1B4D3E', accent:'#2D8659' } },
      business_green:{ name:'å°ˆæ¥­å•†å‹™ç¶ ', header:{ colors:['#1B4D3E','#2F5233','#B8860B'], text:'#FFFFFF' }, agenda:{ background:'#F0F4F0', border:'#2F5233', accent:'#1B4D3E' } },
      tech_green:{ name:'ç¾ä»£ç§‘æŠ€ç¶ ', header:{ colors:['#1B4D3E','#1E6B7A','#4A9EFF'], text:'#FFFFFF' }, agenda:{ background:'#E6F3FF', border:'#1E6B7A', accent:'#1B4D3E' } },
      custom:{ name:'è‡ªè¨‚é…è‰²', 
        header:{ colors:[customColors.headerC1,customColors.headerC2,customColors.headerC3], text:'#FFFFFF' }, 
        agenda:{ background:customColors.agendaBg, border:customColors.agendaBorder, accent:customColors.agendaAccent } 
      }
    };
    
    const gradientDirections = { 
      horizontal:{x1:0,y1:0,x2:1,y2:0}, 
      vertical:{x1:0,y1:0,x2:0,y2:1}, 
      diagonal:{x1:0,y1:0,x2:1,y2:1},
      radial: 'radial' // ç‰¹æ®Šæ¨™è¨˜ï¼Œè¡¨ç¤ºä½¿ç”¨æ”¾å°„ç‹€æ¼¸å±¤
    };
    
    const templates = {
      lung:{ icon:'ğŸ«', title:'è‚ºç™Œ', color:'#4A90E2', sampleItems:[
        {time:'08:30-09:00',topic:'å ±åˆ°è¨»å†Š',speaker:'',moderator:''},
        {time:'09:00-09:30',topic:'è‚ºç™Œç¯©æª¢æœ€æ–°é€²å±•',speaker:'èƒ¸è…”ç§‘ä¸»ä»»',moderator:'å‘¼å¸æ²»ç™‚å¸«'},
        {time:'09:30-10:30',topic:'å…ç–«æ²»ç™‚åœ¨è‚ºç™Œçš„æ‡‰ç”¨',speaker:'è…«ç˜¤ç§‘é†«å¸«',moderator:'å…§ç§‘é†«å¸«'},
        {time:'10:30-11:00',topic:'èŒ¶æ­‡æ™‚é–“',speaker:'',moderator:''},
        {time:'11:00-12:00',topic:'ç²¾æº–é†«ç™‚èˆ‡åŸºå› æª¢æ¸¬',speaker:'ç—…ç†ç§‘æ•™æˆ',moderator:'åˆ†å­è¨ºæ–·å°ˆå®¶'} ] },
      headneck:{ icon:'ğŸ‘¤', title:'é ­é ¸ç™Œ', color:'#E74C3C', sampleItems:[
        {time:'08:30-09:00',topic:'å ±åˆ°è¨»å†Š',speaker:'',moderator:''},
        {time:'09:00-09:30',topic:'é ­é ¸ç™Œæ—©æœŸè¨ºæ–·ç­–ç•¥',speaker:'è€³é¼»å–‰ç§‘ä¸»ä»»',moderator:'å½±åƒé†«å­¸ç§‘é†«å¸«'},
        {time:'09:30-10:30',topic:'æ”¾å°„æ²»ç™‚æ–°æŠ€è¡“',speaker:'æ”¾å°„è…«ç˜¤ç§‘é†«å¸«',moderator:'ç‰©ç†å¸«'},
        {time:'10:30-11:00',topic:'ä¼‘æ¯æ™‚é–“',speaker:'',moderator:''},
        {time:'11:00-12:00',topic:'é‡å»ºæ‰‹è¡“æ¡ˆä¾‹è¨è«–',speaker:'æ•´å½¢å¤–ç§‘æ•™æˆ',moderator:'é ­é ¸å¤–ç§‘é†«å¸«'} ] },
      uterus:{ icon:'â™€ï¸', title:'å­å®®é«”ç™Œ', color:'#FF69B4', sampleItems:[
        {time:'08:30-09:00',topic:'å ±åˆ°è¨»å†Š',speaker:'',moderator:''},
        {time:'09:00-09:30',topic:'å­å®®å…§è†œç™Œåˆ†æœŸèˆ‡æ²»ç™‚',speaker:'å©¦ç”¢ç§‘ä¸»ä»»',moderator:'ç—…ç†ç§‘é†«å¸«'},
        {time:'09:30-10:30',topic:'å¾®å‰µæ‰‹è¡“æŠ€è¡“é€²å±•',speaker:'å©¦ç™Œç§‘é†«å¸«',moderator:'éº»é†‰ç§‘é†«å¸«'},
        {time:'10:30-11:00',topic:'èŒ¶æ­‡',speaker:'',moderator:''},
        {time:'11:00-12:00',topic:'è·çˆ¾è’™æ²»ç™‚èˆ‡è¿½è¹¤',speaker:'å…§åˆ†æ³Œç§‘æ•™æˆ',moderator:'å©¦ç”¢ç§‘é†«å¸«'} ] },
      urinary:{ icon:'ğŸ©º', title:'æ³Œå°¿é“ç™Œ', color:'#3498DB', sampleItems:[
        {time:'08:30-09:00',topic:'å ±åˆ°è¨»å†Š',speaker:'',moderator:''},
        {time:'09:00-09:30',topic:'è†€èƒ±ç™Œè¨ºæ–·èˆ‡åˆ†æœŸ',speaker:'æ³Œå°¿ç§‘ä¸»ä»»',moderator:'å½±åƒé†«å­¸ç§‘é†«å¸«'},
        {time:'09:30-10:30',topic:'è…è‡Ÿç™Œæ¨™é¶æ²»ç™‚',speaker:'è…«ç˜¤ç§‘é†«å¸«',moderator:'è—¥åŠ‘å¸«'},
        {time:'10:30-11:00',topic:'ä¼‘æ¯æ™‚é–“',speaker:'',moderator:''},
        {time:'11:00-12:00',topic:'æ”è­·è…ºç™Œè·çˆ¾è’™æ²»ç™‚',speaker:'æ³Œå°¿è…«ç˜¤ç§‘æ•™æˆ',moderator:'æ³Œå°¿ç§‘é†«å¸«'} ] },
      colorectal:{ icon:'ğŸ©»', title:'å¤§è…¸ç›´è…¸ç™Œ', color:'#F39C12', sampleItems:[
        {time:'08:30-09:00',topic:'å ±åˆ°è¨»å†Š',speaker:'',moderator:''},
        {time:'09:00-09:30',topic:'å¤§è…¸ç™Œç¯©æª¢èˆ‡é é˜²',speaker:'å¤§è…¸ç›´è…¸å¤–ç§‘ä¸»ä»»',moderator:'å®¶é†«ç§‘é†«å¸«'},
        {time:'09:30-10:30',topic:'è…¹è…”é¡æ‰‹è¡“æŠ€è¡“',speaker:'å¤–ç§‘é†«å¸«',moderator:'æ‰‹è¡“å®¤è­·ç†å¸«'},
        {time:'10:30-11:00',topic:'èŒ¶æ­‡æ™‚é–“',speaker:'',moderator:''},
        {time:'11:00-12:00',topic:'è½‰ç§»æ€§å¤§è…¸ç™Œæ²»ç™‚ç­–ç•¥',speaker:'è…«ç˜¤ç§‘æ•™æˆ',moderator:'è‡¨åºŠè—¥å¸«'} ] },
      breast:{ icon:'ğŸ—ï¸', title:'ä¹³ç™Œ', color:'#E91E63', sampleItems:[
        {time:'08:30-09:00',topic:'å ±åˆ°è¨»å†Š',speaker:'',moderator:''},
        {time:'09:00-09:30',topic:'ä¹³ç™ŒåŸºå› æª¢æ¸¬èˆ‡é¢¨éšªè©•ä¼°',speaker:'ä¹³æˆ¿å¤–ç§‘ä¸»ä»»',moderator:'éºå‚³è«®è©¢å¸«'},
        {time:'09:30-10:30',topic:'HER2é™½æ€§ä¹³ç™Œæ²»ç™‚',speaker:'è…«ç˜¤ç§‘é†«å¸«',moderator:'ä¹³æˆ¿å°ˆç§‘è­·ç†å¸«'},
        {time:'10:30-11:00',topic:'ä¼‘æ¯æ™‚é–“',speaker:'',moderator:''},
        {time:'11:00-12:00',topic:'ä¹³æˆ¿é‡å»ºèˆ‡ç¾å®¹',speaker:'æ•´å½¢å¤–ç§‘æ•™æˆ',moderator:'ä¹³ç™Œç—…å‹ä»£è¡¨'} ] }
    };

    // ====== PNG åœ–å±¤ç‹€æ…‹ ======
    let overlays = []; // ç”±ä¸‹åˆ°ä¸Šæ’åºï¼ˆé™£åˆ—å°¾ç«¯ä»£è¡¨æœ€ä¸Šå±¤ï¼‰
    let selectedOverlayIndex = -1;

    // ====== è¼”åŠ© ======
    function getCanvas(){ return document.getElementById('posterCanvas'); }
    function getCtx(){ return getCanvas().getContext('2d'); }
    function createGradient(ctx, w, h, colors, direction){ 
      if (direction === 'radial') {
        const centerX = w / 2;
        const centerY = h / 2;
        const radius = Math.max(w, h) / 2;
        const g = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
        colors.forEach((c,i)=>g.addColorStop(i/(colors.length-1), c)); 
        return g;
      } else {
        const d = gradientDirections[direction]; 
        const g = ctx.createLinearGradient(d.x1*w,d.y1*h,d.x2*w,d.y2*h); 
        colors.forEach((c,i)=>g.addColorStop(i/(colors.length-1), c)); 
        return g;
      }
    }

    // ====== è­°ç¨‹ UI ======
    function refreshAgendaList(){ 
      const list = document.getElementById('agendaList'); 
      list.innerHTML = ''; 
      agendaItems.forEach((it,idx)=>{
        const d=document.createElement('div'); 
        d.className='agenda-item'; 
        d.innerHTML = `
          <div class="controls">
            <button class="btn btn-ghost" onclick="editAgenda(${idx})">âœï¸</button>
            <button class="btn btn-danger" onclick="delAgenda(${idx})">âœ•</button>
          </div>
          <div style='font-weight:700;color:#667eea;'>${it.time}</div>
          <div><strong>${it.topic.replace(/\n/g, '<br>')}</strong></div>
          ${it.speaker?`<div>è¬›è€…ï¼š${it.speaker.replace(/\n/g, '<br>')}</div>`:''}
          ${it.moderator?`<div>ä¸»æŒäººï¼š${it.moderator.replace(/\n/g, '<br>')}</div>`:''}
        `; 
        list.appendChild(d); 
      }); 
    }
    
    window.editAgenda = function(i){ 
      const it=agendaItems[i]; 
      document.getElementById('agendaTime').value=it.time; 
      document.getElementById('agendaTopic').value=it.topic; 
      document.getElementById('agendaSpeaker').value=it.speaker||''; 
      document.getElementById('agendaModerator').value=it.moderator||''; 
      document.getElementById('agendaAdd').textContent='ğŸ’¾ æ›´æ–°'; 
      document.getElementById('agendaAdd').dataset.edit=i; 
    }
    
    window.delAgenda = function(i){ 
      if(confirm('ç¢ºå®šåˆªé™¤é€™å€‹è­°ç¨‹é …ç›®ï¼Ÿ')){ 
        agendaItems.splice(i,1); 
        refreshAgendaList(); 
        updatePoster(); 
      } 
    }

    // ====== PNG åœ–å±¤ï¼šå»ºç«‹/UI ======
    function newOverlayFromImage(img, name, src){
      const c=getCanvas();
      const ov = {
        id: Date.now()+Math.random(),
        name: name || 'overlay.png',
        img, src: src||'',
        x: c.width/2, y: c.height/2,
        w: img.naturalWidth || img.width,
        h: img.naturalHeight || img.height,
        scaleX: Math.max(0.05, (c.width*0.4)/(img.naturalWidth||img.width)),
        scaleY: Math.max(0.05, (c.width*0.4)/(img.naturalWidth||img.width)),
        rotation: 0,
        opacity: 1,
        visible: true,
        lockAspect: true,
        crop: {x:0, y:0, w: img.naturalWidth||img.width, h: img.naturalHeight||img.height}
      };
      overlays.push(ov); selectedOverlayIndex = overlays.length-1; refreshOverlayList(); syncOverlayControls(); updatePoster();
    }

    function refreshOverlayList(){ const list = document.getElementById('overlayList'); list.innerHTML=''; overlays.forEach((ov, idx)=>{
      const item = document.createElement('div'); item.className = 'overlay-item'+(idx===selectedOverlayIndex?' active':'');
      item.onclick = ()=>{ selectedOverlayIndex = idx; refreshOverlayList(); syncOverlayControls(); updatePoster(); };
      const thumb = document.createElement('div'); thumb.className='overlay-thumb'; thumb.style.backgroundImage = `url(${ov.src})`;
      const name = document.createElement('div'); name.className='overlay-name'; name.textContent = ov.name;
      const actions = document.createElement('div'); actions.className='overlay-actions';
      const eye = document.createElement('button'); eye.className='btn btn-ghost'; eye.textContent = ov.visible?'ğŸ‘ï¸':'ğŸš«'; eye.title='é¡¯ç¤º/éš±è—'; eye.onclick=(e)=>{ e.stopPropagation(); ov.visible=!ov.visible; syncOverlayControls(); updatePoster(); refreshOverlayList(); };
      const del = document.createElement('button'); del.className='btn btn-danger'; del.textContent='âœ•'; del.title='åˆªé™¤'; del.onclick=(e)=>{ e.stopPropagation(); if(confirm('åˆªé™¤æ­¤ PNG åœ–å±¤ï¼Ÿ')){ overlays.splice(idx,1); if(selectedOverlayIndex>=overlays.length) selectedOverlayIndex=overlays.length-1; refreshOverlayList(); syncOverlayControls(); updatePoster(); } };
      actions.appendChild(eye); actions.appendChild(del);
      item.appendChild(thumb); item.appendChild(name); item.appendChild(actions);
      list.appendChild(item);
    });
    }

    function syncOverlayControls(){ const ov = overlays[selectedOverlayIndex];
      const has = !!ov; document.getElementById('overlayOpacity').disabled = !has;
      document.getElementById('overlayVisible').disabled = !has; document.getElementById('overlayLockAspect').disabled = !has;
      document.getElementById('centerOverlay').disabled = !has; document.getElementById('resetOverlay').disabled=!has; document.getElementById('removeOverlay').disabled=!has;
      document.getElementById('openCropper').disabled=!has; document.getElementById('resetCrop').disabled=!has;
      if(!has) return;
      document.getElementById('overlayOpacity').value = ov.opacity; document.getElementById('overlayVisible').checked = ov.visible; document.getElementById('overlayLockAspect').checked = ov.lockAspect;
    }

    // ====== æ–‡å­—è™•ç†å‡½æ•¸ï¼ˆæ”¯æ´æ‰‹å‹•æ›è¡Œä¸”æ¯è¡Œéƒ½å±…ä¸­å°é½Šï¼‰======
    function calculateTextLinesWithBreaks(ctx, text, maxWidth) {
      if (!text) return 1;
      const manualLines = text.split('\n');
      let totalLines = 0;
      
      manualLines.forEach(line => {
        if (!line.trim()) {
          totalLines += 1;
          return;
        }
        
        const isC = /[\u4e00-\u9fff]/.test(line);
        const words = isC ? line.split('').filter(c => c.trim() !== '') : line.split(' ');
        let currentLine = '';
        let lineCount = 0;
        
        for (let i = 0; i < words.length; i++) {
          const test = isC ? currentLine + words[i] : currentLine + words[i] + ' ';
          if (ctx.measureText(test).width > maxWidth && currentLine !== '') {
            lineCount++;
            currentLine = isC ? words[i] : words[i] + ' ';
          } else {
            currentLine = test;
          }
        }
        if (currentLine.trim() !== '') lineCount++;
        totalLines += Math.max(1, lineCount);
      });
      
      return totalLines;
    }

function wrapTextWithBreaks(ctx, text, x, y, maxWidth, lineHeight, align = 'left') {
  if (!text) return 0;
  const manualLines = text.split('\n');
  let currentY = y;
  
  manualLines.forEach(line => {
    if (!line.trim()) {
      currentY += lineHeight;
      return;
    }
    
    const isC = /[\u4e00-\u9fff]/.test(line);
    const words = isC ? line.split('').filter(c => c.trim() !== '') : line.split(' ');
    let currentLine = '';
    let linesToDraw = [];
    
    for (let i = 0; i < words.length; i++) {
      const test = isC ? currentLine + words[i] : currentLine + words[i] + ' ';
      if (ctx.measureText(test).width > maxWidth && currentLine !== '') {
        linesToDraw.push(currentLine.trim());
        currentLine = isC ? words[i] : words[i] + ' ';
      } else {
        currentLine = test;
      }
    }
    if (currentLine.trim() !== '') linesToDraw.push(currentLine.trim());
    
    linesToDraw.forEach(lineText => {
      let drawX = x;
      if (align === 'center') {
        const textWidth = ctx.measureText(lineText).width;
        drawX = x + (maxWidth / 2) - (textWidth / 2);  // ä¿®æ”¹é€™è¡Œ
      } else if (align === 'right') {
        const textWidth = ctx.measureText(lineText).width;
        drawX = x + maxWidth - textWidth;
      }
      ctx.fillText(lineText, drawX, currentY);
      currentY += lineHeight;
    });
  });
  
  return currentY - y;
}

    function drawCenteredTextWithBreaks(ctx, text, x, y, maxWidth, lineHeight, cellHeight, align = 'center') {
      if (!text) return 0;
      
      const totalLines = calculateTextLinesWithBreaks(ctx, text, maxWidth);
      const textHeight = totalLines * lineHeight;
      const startY = y + (cellHeight - textHeight) / 2 + lineHeight * 0.8; // å‚ç›´å±…ä¸­ä¸¦èª¿æ•´åŸºç·š
      
      return wrapTextWithBreaks(ctx, text, x, startY, maxWidth, lineHeight, align);
    }

    function drawCancerDecorations(ctx, template, canvas){ try{ const scheme = getActiveColorScheme(); ctx.globalAlpha=.15; ctx.fillStyle=scheme.agenda.accent; ctx.strokeStyle=scheme.agenda.accent; switch(template.title){ case 'è‚ºç™Œ': ctx.beginPath(); ctx.arc(canvas.width-100,300,40,0,Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(canvas.width-60,300,35,0,Math.PI*2); ctx.stroke(); break; case 'é ­é ¸ç™Œ': ctx.beginPath(); ctx.arc(canvas.width-100,280,30,0,Math.PI); ctx.stroke(); ctx.fillRect(canvas.width-110,310,20,40); break; case 'å­å®®é«”ç™Œ': for(let i=0;i<5;i++){ ctx.beginPath(); ctx.arc(canvas.width-150+i*20,300,8,0,Math.PI*2); ctx.fill(); } break; case 'æ³Œå°¿é“ç™Œ': ctx.beginPath(); ctx.ellipse(canvas.width-100,300,25,40,0,0,Math.PI*2); ctx.stroke(); break; case 'å¤§è…¸ç›´è…¸ç™Œ': ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(canvas.width-150,250); ctx.quadraticCurveTo(canvas.width-100,300,canvas.width-50,350); ctx.stroke(); break; case 'ä¹³ç™Œ': ctx.lineWidth=8; ctx.beginPath(); ctx.moveTo(canvas.width-120,280); ctx.quadraticCurveTo(canvas.width-80,250,canvas.width-60,300); ctx.quadraticCurveTo(canvas.width-80,350,canvas.width-120,320); ctx.stroke(); break; } ctx.globalAlpha=1; }catch(e){ ctx.globalAlpha=1; } }

    function calculateRequiredHeight(ctx, canvasWidth){ 
        let total = 300;

  if (agendaItems.length > 0) {
    ctx.font = '16px Microsoft JhengHei';

    // Header block + column header row
    let agendaH = 75 /* section title area */ + 35 /* gap */ + 45 /* column header row */;

    // === Column geometry (responsive, non-overlapping) ===
    const tableOuterLeft = 40;        // outer table background left edge
    const tableOuterRight = canvasWidth - 40; // outer table background right edge
    const innerPad = 20;              // inner left/right breathing room inside the table
    const innerLeft = tableOuterLeft + innerPad;      // 60 when width=800
    const innerRight = tableOuterRight - innerPad;    // 740 when width=800
    const innerWidth = innerRight - innerLeft;        // 680 when width=800

    // Column width ratios (sum = 1.0)
    const wTime = Math.round(innerWidth * 0.1765);     // â‰ˆ120 at 800px
    const wTopic = Math.round(innerWidth * 0.4412);    // â‰ˆ300
    const wSpeaker = Math.round(innerWidth * 0.2059);  // â‰ˆ140
    const wModerator = innerWidth - wTime - wTopic - wSpeaker; // remainder (â‰ˆ120)

    // Slight inner text padding so wrapping looks nicer
    const pad = 10;

    agendaItems.forEach(item => {
      const topicLines = calculateTextLinesWithBreaks(ctx, item.topic, Math.max(10, wTopic - pad));
      const speakerLines = item.speaker ? calculateTextLinesWithBreaks(ctx, item.speaker, Math.max(10, wSpeaker - pad)) : 1;
      const moderatorLines = item.moderator ? calculateTextLinesWithBreaks(ctx, item.moderator, Math.max(10, wModerator - pad)) : 1;
      const timeLines = calculateTextLinesWithBreaks(ctx, item.time, Math.max(10, wTime - pad));

      const maxLines = Math.max(topicLines, speakerLines, moderatorLines, timeLines);
      const rowH = Math.max(50, maxLines * 22 + 16);
      agendaH += rowH;
    });

    total += agendaH + 40;
  }

  // Footer note height (if any)
  const showFooter = document.getElementById('showFooterNote')?.checked;
  const txt = (document.getElementById('footerNoteContent')?.value || '').trim();
  if (showFooter && txt) {
    ctx.font = '11px Microsoft JhengHei';
    const noteW = canvasWidth - 80;
    const noteLines = calculateTextLinesWithBreaks(ctx, txt, noteW);
    const noteH = 0 + (noteLines * 1); // æ¸›å°‘å°¾ç«¯ç©ºç™½
    total += noteH;
  }

  total += 5; // bottom padding
  return Math.max(total, 600);
    }

    // å–å¾—ç•¶å‰é…è‰²æ–¹æ¡ˆï¼ˆå‹•æ…‹æ›´æ–°è‡ªè¨‚é…è‰²ï¼‰
    function getActiveColorScheme() {
      if (currentColorScheme === 'custom') {
        return {
          header: { 
            colors: [customColors.headerC1, customColors.headerC2, customColors.headerC3], 
            text: '#FFFFFF' 
          }, 
          agenda: { 
            background: customColors.agendaBg, 
            border: customColors.agendaBorder, 
            accent: customColors.agendaAccent 
          }
        };
      }
      return colorSchemes[currentColorScheme];
    }

    function drawPosterToCanvas(ctx, W, H){
        let total = 300;

  if (agendaItems.length > 0) {
    ctx.font = '16px Microsoft JhengHei';

    // Header block + column header row
    let agendaH = 75 /* section title area */ + 35 /* gap */ + 45 /* column header row */;

    // === Column geometry (responsive, non-overlapping) ===
    const tableOuterLeft = 40;        // outer table background left edge
    const tableOuterRight = W - 40; // outer table background right edge
    const innerPad = 20;              // inner left/right breathing room inside the table
    const innerLeft = tableOuterLeft + innerPad;      // 60 when width=800
    const innerRight = tableOuterRight - innerPad;    // 740 when width=800
    const innerWidth = innerRight - innerLeft;        // 680 when width=800

    // Column width ratios (sum = 1.0)
    const wTime = Math.round(innerWidth * 0.1765);     // â‰ˆ120 at 800px
    const wTopic = Math.round(innerWidth * 0.4412);    // â‰ˆ300
    const wSpeaker = Math.round(innerWidth * 0.2059);  // â‰ˆ140
    const wModerator = innerWidth - wTime - wTopic - wSpeaker; // remainder (â‰ˆ120)

    // Slight inner text padding so wrapping looks nicer
    const pad = 10;

    agendaItems.forEach(item => {
      const topicLines = calculateTextLinesWithBreaks(ctx, item.topic, Math.max(10, wTopic - pad));
      const speakerLines = item.speaker ? calculateTextLinesWithBreaks(ctx, item.speaker, Math.max(10, wSpeaker - pad)) : 1;
      const moderatorLines = item.moderator ? calculateTextLinesWithBreaks(ctx, item.moderator, Math.max(10, wModerator - pad)) : 1;
      const timeLines = calculateTextLinesWithBreaks(ctx, item.time, Math.max(10, wTime - pad));

      const maxLines = Math.max(topicLines, speakerLines, moderatorLines, timeLines);
      const rowH = Math.max(50, maxLines * 22 + 16);
      agendaH += rowH;
    });

    total += agendaH + 40;
  }

  // Footer note height (if any)
  const showFooter = document.getElementById('showFooterNote')?.checked;
  const txt = (document.getElementById('footerNoteContent')?.value || '').trim();
  if (showFooter && txt) {
    ctx.font = '11px Microsoft JhengHei';
    const noteW = canvasWidth - 80;
    const noteLines = calculateTextLinesWithBreaks(ctx, txt, noteW);
    const noteH = 20 + (noteLines * 15);
    total += noteH;
  }

  total += 5; // bottom padding
  return Math.max(total, 600);
}

function drawPosterToCanvas(ctx, W, H) {
  const scheme = getActiveColorScheme();
  const template = templates[currentTemplate];

  // === Background (with optional custom gradient) ===
  if (currentColorScheme === 'custom' && customColors.bgGradientDir !== 'none') {
    ctx.fillStyle = createGradient(ctx, W, H, [customColors.bgC1, customColors.bgC2], customColors.bgGradientDir);
  } else {
    ctx.fillStyle = currentColorScheme === 'custom' ? customColors.bgC1 : '#fff';
  }
  ctx.fillRect(0, 0, W, H);

  // === Header wave ===
  const headerHeight = 120;
  ctx.fillStyle = createGradient(ctx, W, headerHeight, scheme.header.colors, currentGradientDirection);
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(W, 0);
  ctx.lineTo(W, 100);
  ctx.quadraticCurveTo(W * 0.75, 130, W * 0.5, 110);
  ctx.quadraticCurveTo(W * 0.25, 90, 0, 120);
  ctx.closePath();
  ctx.fill();

  const title = (document.getElementById('conferenceTitle').value || `${template.title}é†«å­¸æœƒè­°`);
  ctx.fillStyle = scheme.header.text;
  ctx.font = 'bold 36px Microsoft JhengHei';
  ctx.textAlign = 'center';
  ctx.fillText(title, W / 2, 50);

  const subtitle = document.getElementById('conferenceSubtitle').value;
  if (subtitle) {
    ctx.font = '20px Microsoft JhengHei';
    ctx.fillText(subtitle, W / 2, 85);
  }

  // === Info (date/place) ===
  const infoCardY = 140, infoCardH = 80;
  const date = document.getElementById('conferenceDate').value;
  const location = document.getElementById('conferenceLocation').value;
  ctx.fillStyle = '#333';
  ctx.font = '18px Microsoft JhengHei';
  ctx.textAlign = 'left';
  if (date) ctx.fillText('ğŸ“… ' + date, 60, infoCardY + 30);
  if (location) ctx.fillText('ğŸ¢ ' + location, 60, infoCardY + 60);

  // === Agenda ===
  let afterAgendaY = infoCardY + infoCardH + 40;
  if (agendaItems.length > 0) {
    const agendaStartY = afterAgendaY;

    // Section title bar
    ctx.fillStyle = scheme.agenda.background;
    ctx.fillRect(30, agendaStartY - 20, W - 60, 40);
    ctx.fillStyle = scheme.agenda.border;
    ctx.font = 'bold 26px Microsoft JhengHei';
    ctx.textAlign = 'center';
    ctx.fillText('è­°ç¨‹å®‰æ’', W / 2, agendaStartY + 5);

    // === Column geometry (responsive, non-overlapping) ===
    const tableOuterLeft = 40;
    const tableOuterRight = W - 40;
    const innerPad = 20; // breathing room at both sides
    const innerLeft = tableOuterLeft + innerPad;      // 60
    const innerRight = tableOuterRight - innerPad;    // W-60
    const innerWidth = innerRight - innerLeft;        // W-120

    const wTime = Math.round(innerWidth * 0.1765);     // â‰ˆ120
    const wTopic = Math.round(innerWidth * 0.4412);    // â‰ˆ300
    const wSpeaker = Math.round(innerWidth * 0.2059);  // â‰ˆ140
    const wModerator = innerWidth - wTime - wTopic - wSpeaker; // remainder (keeps total exact)

    const xTime = innerLeft;
    const xTopic = xTime + wTime;
    const xSpeaker = xTopic + wTopic;
    const xModerator = xSpeaker + wSpeaker; // will end at innerRight

    const cTime = xTime + wTime / 2;
    const cTopic = xTopic + wTopic / 2;
    const cSpeaker = xSpeaker + wSpeaker / 2;
    const cModerator = xModerator + wModerator / 2;

// Column header row
    let yPos = agendaStartY + 50;
    ctx.fillStyle = scheme.agenda.accent;
    ctx.fillRect(tableOuterLeft, yPos - 8, W - 80, 35);

    ctx.fillStyle = '#FFFFFF';
    ctx.font = 'bold 16px Microsoft JhengHei';
    ctx.textAlign = 'center';
    ctx.fillText('Time', cTime, yPos + 15);
    ctx.fillText('Content', cTopic, yPos + 15);
    ctx.fillText('Speaker', cSpeaker, yPos + 15);
    ctx.fillText('Moderator', cModerator, yPos + 15);

    yPos += 45; // space for column header row

// Body rows ï¼ æ”¯æ´è‡ªå‹•æ›è¡Œèˆ‡å‚ç›´ç½®ä¸­
agendaItems.forEach((item, idx) => {
  ctx.font = '16px Microsoft JhengHei';
  const pad = 10;

  // å…ˆç”¨èˆ‡è¨ˆé«˜ä¸€è‡´çš„æ–¹å¼ç®—è¡Œæ•¸ï¼Œå¾—åˆ°åŒä¸€å€‹ row é«˜åº¦
  const timeLines = calculateTextLinesWithBreaks(ctx, item.time, wTime - pad);
  const topicLines = calculateTextLinesWithBreaks(ctx, item.topic, wTopic - pad);
  const speakerLines = item.speaker ? calculateTextLinesWithBreaks(ctx, item.speaker, wSpeaker - pad) : 1;
  const moderatorLines = item.moderator ? calculateTextLinesWithBreaks(ctx, item.moderator, wModerator - pad) : 1;
  const maxLines = Math.max(timeLines, topicLines, speakerLines, moderatorLines);
  const itemH = Math.max(45, maxLines * 22 + 15);

  // æ–‘é¦¬ç´‹åº•è‰²
  if (idx % 2 === 0) {
    ctx.fillStyle = scheme.agenda.background;
    ctx.fillRect(tableOuterLeft, yPos - 18, W - 80, itemH);
  }

  // ç‚ºäº†ç”¨çµ•å°åº§æ¨™ç¹ªå­—ï¼Œåˆ‡å› left å°é½Šï¼ˆçœŸæ­£æ°´å¹³ç½®ä¸­çš„ä½ç§»ç”±å‡½å¼è¨ˆç®—ï¼‰
  ctx.textAlign = 'left';

  // Time
  ctx.fillStyle = scheme.agenda.accent;
  ctx.font = 'bold 16px Microsoft JhengHei';
  drawCenteredTextWithBreaks(
    ctx,
    item.time || '',
    xTime + pad / 2,         // æ¬„ä½å·¦ç·£ + å…§è·
    yPos - 18,               // æ¬„ä½é ‚
    wTime - pad,             // å¯ç”¨å¯¬åº¦
    22,                      // è¡Œé«˜
    itemH,                   // å„²å­˜æ ¼é«˜åº¦ï¼ˆç”¨ä¾†å‚ç›´ç½®ä¸­ï¼‰
    'center'                 // æ°´å¹³ç½®ä¸­
  );

  // Topic
  ctx.fillStyle = '#333';
  ctx.font = '16px Microsoft JhengHei';
  drawCenteredTextWithBreaks(
    ctx,
    item.topic || '',
    xTopic + pad / 2,
    yPos - 18,
    wTopic - pad,
    22,
    itemH,
    'center'
  );

  // Speaker
  ctx.fillStyle = scheme.agenda.accent;
  ctx.font = '14px Microsoft JhengHei';
  drawCenteredTextWithBreaks(
    ctx,
    item.speaker || '',
    xSpeaker + pad / 2,
    yPos - 18,
    wSpeaker - pad,
    20,
    itemH,
    'center'
  );

  // Moderator
  ctx.fillStyle = scheme.agenda.border;
  ctx.font = '14px Microsoft JhengHei';
  drawCenteredTextWithBreaks(
    ctx,
    item.moderator || '',
    xModerator + pad / 2,
    yPos - 18,
    wModerator - pad,
    20,
    itemH,
    'center'
  );

  yPos += itemH + 5;
});

    afterAgendaY = yPos + 10;
  }

  // === Footer note (no border) ===
  const showFooter = document.getElementById('showFooterNote')?.checked;
  const noteText = (document.getElementById('footerNoteContent')?.value || '').trim();
  if (showFooter && noteText) {
    const noteX = 40, noteW = W - 80, noteY = afterAgendaY + 20;
    ctx.fillStyle = '#333';
    ctx.font = '11px Microsoft JhengHei';
    ctx.textAlign = 'left';
    const lines = calculateTextLinesWithBreaks(ctx, noteText, noteW);
    const contentH = lines * 15;
    wrapTextWithBreaks(ctx, noteText, noteX, noteY, noteW, 15);
    afterAgendaY = noteY + contentH;
  }

  // On-theme subtle iconography
  drawCancerDecorations(ctx, template, { width: W, height: H });

  // PNG overlays from bottom to top
  overlays.forEach((ov, idx) => drawOverlay(ctx, ov, idx === selectedOverlayIndex));
    }

    function updatePoster(){ const canvas=getCanvas(); const ctx=getCtx(); const temp = document.createElement('canvas'); temp.width=canvas.width; temp.height=2000; const tctx=temp.getContext('2d'); const needH = calculateRequiredHeight(tctx, canvas.width); if(canvas.height!==needH){ canvas.height = needH; }
      // ç¢ºä¿é¸å–ç‰©ä»¶ä»åœ¨ç•«å¸ƒå…§
      if(selectedOverlayIndex>=0){ const ov=overlays[selectedOverlayIndex]; ov.x = Math.max(0, Math.min(canvas.width, ov.x)); ov.y = Math.max(0, Math.min(canvas.height, ov.y)); }
      drawPosterToCanvas(ctx, canvas.width, canvas.height);
    }

    function downloadPoster(){ try{ const c=getCanvas(); const scale=4.8, w=c.width*scale, h=c.height*scale; const u=document.createElement('canvas'); u.width=w; u.height=h; const ux=u.getContext('2d'); ux.imageSmoothingEnabled=true; ux.imageSmoothingQuality='high'; ux.scale(scale,scale); drawPosterToCanvas(ux, c.width, c.height); const a=document.createElement('a'); a.download=`${templates[currentTemplate].title}_æœƒè­°æµ·å ±_UHD_${new Date().toISOString().slice(0,10)}.png`; a.href=u.toDataURL('image/png',1.0); document.body.appendChild(a); a.click(); document.body.removeChild(a); }catch(e){ const c=getCanvas(); const a=document.createElement('a'); a.download=`${templates[currentTemplate].title}_æœƒè­°æµ·å ±_${new Date().toISOString().slice(0,10)}.png`; a.href=c.toDataURL('image/png'); document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    }

    // ====== äº’å‹•ï¼šPNG åœ–å±¤åœ¨ä¸»ç•«å¸ƒï¼ˆæ‹–æ‹‰/ç¸®æ”¾/æ—‹è½‰ï¼‰======
    function overlaySize(ov){ return { w: ov.w*ov.scaleX, h: ov.h*ov.scaleY }; }
    function toLocal(ov, pt){ const dx = pt.x - ov.x, dy = pt.y - ov.y; const cos=Math.cos(-ov.rotation), sin=Math.sin(-ov.rotation); return { x: dx*cos - dy*sin, y: dx*sin + dy*cos } }
    function toGlobal(ov, lp){ const cos=Math.cos(ov.rotation), sin=Math.sin(ov.rotation); return { x: ov.x + (lp.x*cos - lp.y*sin), y: ov.y + (lp.x*sin + lp.y*cos) } }

    function handlePositions(ov){ const s=overlaySize(ov); const hw=s.w/2, hh=s.h/2; return [
      {name:'nw', x:-hw, y:-hh}, {name:'n', x:0, y:-hh}, {name:'ne', x:hw, y:-hh},
      {name:'e', x:hw, y:0}, {name:'se', x:hw, y:hh}, {name:'s', x:0, y:hh},
      {name:'sw', x:-hw, y:hh}, {name:'w', x:-hw, y:0}
    ]; }
    function rotateHandle(ov){ const s=overlaySize(ov); return {name:'rot', x:0, y:-(s.h/2)-30}; }

    function drawOverlay(ctx, ov, selected){ if(!ov.img || !ov.visible) return; const s=overlaySize(ov);
      ctx.save(); ctx.globalAlpha=ov.opacity; ctx.translate(ov.x, ov.y); ctx.rotate(ov.rotation);
      // ä½¿ç”¨è£åˆ‡ï¼šå¾ä¾†æºè£åˆ‡çŸ©å½¢ (ov.crop) ç¹ªè£½åˆ°ç›®æ¨™å¤§å° s.w x s.h
      const cx=ov.crop.x, cy=ov.crop.y, cw=ov.crop.w, ch=ov.crop.h;
      ctx.drawImage(ov.img, cx, cy, cw, ch, -s.w/2, -s.h/2, s.w, s.h);
      ctx.restore();

      if(selected){ ctx.save(); ctx.translate(ov.x, ov.y); ctx.rotate(ov.rotation);
        // é‚Šæ¡†
        ctx.strokeStyle='rgba(0,0,0,.7)'; ctx.lineWidth=1; ctx.setLineDash([6,4]); ctx.strokeRect(-s.w/2, -s.h/2, s.w, s.h); ctx.setLineDash([]);
        // å…«å€‹ç¸®æ”¾æŠŠæ‰‹
        const hs = handlePositions(ov); ctx.fillStyle='#fff'; ctx.strokeStyle='rgba(0,0,0,.85)'; hs.forEach(h=>{ ctx.beginPath(); ctx.rect(h.x-6, h.y-6, 12, 12); ctx.fill(); ctx.stroke(); });
        // æ—‹è½‰æŠŠæ‰‹
        const rot = rotateHandle(ov); ctx.beginPath(); ctx.moveTo(0, -s.h/2); ctx.lineTo(0, rot.y+12); ctx.stroke(); ctx.beginPath(); ctx.arc(rot.x, rot.y, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.restore(); }
    }

    function hitTestOverlay(p){ // å›å‚³ {idx, hit:'none'|'move'|'rotate'|'scale', handle?:name}
      for(let i=overlays.length-1;i>=0;i--){ const ov=overlays[i]; if(!ov.visible) continue; const s=overlaySize(ov); const lp=toLocal(ov, p); const hw=s.w/2, hh=s.h/2; // æ—‹è½‰æŠŠæ‰‹
        const rot = toGlobal(ov, rotateHandle(ov)); const dist = Math.hypot(p.x-rot.x, p.y-rot.y); if(dist<=12) return {idx:i, hit:'rotate'};
        // æŠŠæ‰‹
        const hs=handlePositions(ov); for(const h of hs){ const gh=toGlobal(ov, h); if(Math.abs(p.x-gh.x)<=10 && Math.abs(p.y-gh.y)<=10) return {idx:i, hit:'scale', handle:h.name}; }
        // å…§éƒ¨ï¼ˆæ‹–æ›³ï¼‰
        if(Math.abs(lp.x)<=hw && Math.abs(lp.y)<=hh) return {idx:i, hit:'move'};
      }
      return {idx:-1, hit:'none'};
    }

    const drag = { mode:'none', idx:-1, start:{x:0,y:0}, startOv:null, handle:null, startAngle:0 };

    function onPointerDown(e){ const c=getCanvas(); c.setPointerCapture(e.pointerId); const p=canvasPoint(e); const res = hitTestOverlay(p); drag.mode=res.hit; drag.idx=res.idx; drag.handle=res.handle||null; drag.start = p; if(res.idx>=0){ selectedOverlayIndex = res.idx; refreshOverlayList(); syncOverlayControls(); const ov = overlays[res.idx]; drag.startOv = JSON.parse(JSON.stringify(ov)); // æ·±æ‹·è²
      if(drag.mode==='rotate'){ drag.startAngle = Math.atan2(p.y - ov.y, p.x - ov.x); }
    } else { selectedOverlayIndex=-1; refreshOverlayList(); syncOverlayControls(); }
      updatePoster();
    }
    function onPointerMove(e){ const c=getCanvas(); const p=canvasPoint(e); if(drag.idx<0) return; const ov=overlays[drag.idx]; if(drag.mode==='move'){ ov.x += (p.x - drag.start.x); ov.y += (p.y - drag.start.y); drag.start = p; updatePoster(); }
      else if(drag.mode==='rotate'){ const a = Math.atan2(p.y - ov.y, p.x - ov.x); ov.rotation = drag.startOv.rotation + (a - drag.startAngle); updatePoster(); }
      else if(drag.mode==='scale'){ // æ”¯æ´è§£é–æ¯”ä¾‹ï¼šå…«å‘èª¿æ•´
        const lp = toLocal(ov, p); const s0 = overlaySize(drag.startOv); const s = overlaySize(ov); let sx = drag.startOv.scaleX, sy = drag.startOv.scaleY; const hw0=s0.w/2, hh0=s0.h/2; const lock = ov.lockAspect;
        function clamp(v){ return Math.max(0.05, Math.min(50, v)); }
        switch(drag.handle){
          case 'n': if(lock){ const ry = Math.abs(lp.y)/hh0; sx=clamp(drag.startOv.scaleX*ry); sy=sx; } else { const ry = Math.abs(lp.y)/hh0; sy=clamp(drag.startOv.scaleY*ry); } break;
          case 's': if(lock){ const ry = Math.abs(lp.y)/hh0; sx=clamp(drag.startOv.scaleX*ry); sy=sx; } else { const ry = Math.abs(lp.y)/hh0; sy=clamp(drag.startOv.scaleY*ry); } break;
          case 'e': if(lock){ const rx = Math.abs(lp.x)/hw0; sx=clamp(drag.startOv.scaleX*rx); sy=sx; } else { const rx = Math.abs(lp.x)/hw0; sx=clamp(drag.startOv.scaleX*rx); } break;
          case 'w': if(lock){ const rx = Math.abs(lp.x)/hw0; sx=clamp(drag.startOv.scaleX*rx); sy=sx; } else { const rx = Math.abs(lp.x)/hw0; sx=clamp(drag.startOv.scaleX*rx); } break;
          default: // å››è§’
            if(lock){ const rx = Math.abs(lp.x)/hw0; const ry = Math.abs(lp.y)/hh0; const r = Math.max(rx, ry); sx=clamp(drag.startOv.scaleX*r); sy=sx; }
            else { const rx = Math.abs(lp.x)/hw0; const ry = Math.abs(lp.y)/hh0; sx=clamp(drag.startOv.scaleX*rx); sy=clamp(drag.startOv.scaleY*ry); }
        }
        ov.scaleX=sx; ov.scaleY=sy; updatePoster();
      }
    }
    function onPointerUp(e){ drag.mode='none'; drag.idx=-1; drag.startOv=null; drag.handle=null; }
    function canvasPoint(evt){ const rect=getCanvas().getBoundingClientRect(); return { x:(evt.clientX-rect.left), y:(evt.clientY-rect.top) } }

    function bindCanvasInteractions(){ const c=getCanvas(); c.addEventListener('pointerdown', onPointerDown); c.addEventListener('pointermove', onPointerMove); c.addEventListener('pointerup', onPointerUp); c.addEventListener('pointercancel', onPointerUp); c.addEventListener('wheel', (e)=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; e.preventDefault(); const delta=(e.deltaY<0)?1.06:0.94; ov.scaleX=Math.max(0.05, Math.min(20, ov.scaleX*delta)); ov.scaleY = ov.lockAspect ? ov.scaleX : Math.max(0.05, Math.min(20, ov.scaleY*delta)); updatePoster(); }, {passive:false}); }

    // ====== è£åˆ‡å™¨ï¼ˆç¨ç«‹ç•«å¸ƒï¼Œä»¥åŸåœ–åƒç´ ç‚ºä¸»ï¼‰======
    const cropper = { open:false, scale:1, offsetX:0, offsetY:0, imgW:0, imgH:0, rect:{x:0,y:0,w:0,h:0}, mode:'none', start:{x:0,y:0}, hit:'' };

    function openCropper(){ const ov=overlays[selectedOverlayIndex]; if(!ov) return; const backdrop=document.getElementById('cropperBackdrop'); const cvs=document.getElementById('cropperCanvas'); const ctx=cvs.getContext('2d');
      // è¨ˆç®—ç¸®æ”¾ï¼šå°‡åŸåœ–å®Œæ•´ç½®æ–¼ç•«å¸ƒå…§
      cropper.imgW = ov.w; cropper.imgH = ov.h; const pad=30; const scaleX=(cvs.width-2*pad)/ov.w; const scaleY=(cvs.height-2*pad)/ov.h; cropper.scale=Math.min(scaleX, scaleY, 1); cropper.offsetX=(cvs.width - ov.w*cropper.scale)/2; cropper.offsetY=(cvs.height - ov.h*cropper.scale)/2;
      // åˆå§‹è£åˆ‡æ¡† = ç¾æœ‰ ov.crop
      cropper.rect = { x: ov.crop.x, y: ov.crop.y, w: ov.crop.w, h: ov.crop.h };
      cropper.open=true; backdrop.style.display='flex'; drawCropper();
    }
    function closeCropper(){ document.getElementById('cropperBackdrop').style.display='none'; cropper.open=false; }
    function resetCropper(){ const ov=overlays[selectedOverlayIndex]; if(!ov) return; cropper.rect = {x:0,y:0,w:ov.w,h:ov.h}; drawCropper(); }

    function drawCropper(){ const cvs=document.getElementById('cropperCanvas'); const ctx=cvs.getContext('2d'); const ov=overlays[selectedOverlayIndex]; if(!ov) return; ctx.clearRect(0,0,cvs.width,cvs.height);
      // ç•«åŸåœ–
      ctx.drawImage(ov.img, 0, 0, ov.w, ov.h, cropper.offsetX, cropper.offsetY, ov.w*cropper.scale, ov.h*cropper.scale);
      // é®ç½©
      ctx.save(); ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fillRect(cropper.offsetX, cropper.offsetY, ov.w*cropper.scale, ov.h*cropper.scale);
      // æ¸…å‡ºè£åˆ‡æ¡†å€åŸŸ
      ctx.globalCompositeOperation='destination-out'; const r=cropper.rect; ctx.fillRect(cropper.offsetX + r.x*cropper.scale, cropper.offsetY + r.y*cropper.scale, r.w*cropper.scale, r.h*cropper.scale); ctx.restore();
      // ç•«è£åˆ‡æ¡†
      ctx.save(); ctx.strokeStyle='#10b981'; ctx.lineWidth=2; ctx.setLineDash([6,4]); ctx.strokeRect(cropper.offsetX + r.x*cropper.scale, cropper.offsetY + r.y*cropper.scale, r.w*cropper.scale, r.h*cropper.scale); ctx.setLineDash([]);
      // è§’èˆ‡é‚ŠæŠŠæ‰‹
      const hs = cropHandlesPx(); ctx.fillStyle='#ffffff'; ctx.strokeStyle='#111827'; hs.forEach(h=>{ ctx.beginPath(); ctx.rect(h.x-6, h.y-6, 12, 12); ctx.fill(); ctx.stroke(); });
      ctx.restore();
    }

    function cropHandlesPx(){ const r=cropper.rect, s=cropper.scale, ox=cropper.offsetX, oy=cropper.offsetY; const pts=[
      {name:'nw', x:ox+r.x*s, y:oy+r.y*s}, {name:'n', x:ox+(r.x+r.w/2)*s, y:oy+r.y*s}, {name:'ne', x:ox+(r.x+r.w)*s, y:oy+r.y*s},
      {name:'e', x:ox+(r.x+r.w)*s, y:oy+(r.y+r.h/2)*s}, {name:'se', x:ox+(r.x+r.w)*s, y:oy+(r.y+r.h)*s}, {name:'s', x:ox+(r.x+r.w/2)*s, y:oy+(r.y+r.h)*s},
      {name:'sw', x:ox+r.x*s, y:oy+(r.y+r.h)*s}, {name:'w', x:ox+r.x*s, y:oy+(r.y+r.h/2)*s}
    ]; return pts; }

    function hitCropper(px,py){ const hs=cropHandlesPx(); for(const h of hs){ if(Math.abs(px-h.x)<=10 && Math.abs(py-h.y)<=10) return {hit:'handle', name:h.name}; }
      // å…§éƒ¨æ‹–æ›³
      const r=cropper.rect, s=cropper.scale, ox=cropper.offsetX, oy=cropper.offsetY; const x0=ox+r.x*s, y0=oy+r.y*s, x1=x0+r.w*s, y1=y0+r.h*s; if(px>=x0 && px<=x1 && py>=y0 && py<=y1) return {hit:'inside'}; return {hit:'none'}; }

    function clampRect(rect, maxW, maxH){ const r={...rect}; if(r.w<5) r.w=5; if(r.h<5) r.h=5; if(r.x<0) r.x=0; if(r.y<0) r.y=0; if(r.x+r.w>maxW) r.x = Math.max(0, maxW - r.w); if(r.y+r.h>maxH) r.y = Math.max(0, maxH - r.h); return r; }

    function onCropperDown(e){ const rect=document.getElementById('cropperCanvas').getBoundingClientRect(); const px=e.clientX-rect.left, py=e.clientY-rect.top; const res=hitCropper(px,py); cropper.mode=res.hit; cropper.hit=res.name||''; cropper.start={x:px,y:py}; }
    function onCropperMove(e){ if(cropper.mode==='none') return; const cvs=document.getElementById('cropperCanvas'); const ov=overlays[selectedOverlayIndex]; const rect=cvs.getBoundingClientRect(); const px=e.clientX-rect.left, py=e.clientY-rect.top; const dx=px-cropper.start.x, dy=py-cropper.start.y; const s=cropper.scale; let r={...cropper.rect};
      const applyHandle=(name)=>{ switch(name){
        case 'n': r.y += dy/s; r.h -= dy/s; break; case 's': r.h += dy/s; break; case 'w': r.x += dx/s; r.w -= dx/s; break; case 'e': r.w += dx/s; break;
        case 'nw': r.x += dx/s; r.w -= dx/s; r.y += dy/s; r.h -= dy/s; break; case 'ne': r.w += dx/s; r.y += dy/s; r.h -= dy/s; break; case 'sw': r.x += dx/s; r.w -= dx/s; r.h += dy/s; break; case 'se': r.w += dx/s; r.h += dy/s; break; }
      };
      if(cropper.mode==='inside'){ r.x += dx/s; r.y += dy/s; }
      else if(cropper.mode==='handle'){ applyHandle(cropper.hit); }
      cropper.rect = clampRect(r, ov.w, ov.h); cropper.start={x:px,y:py}; drawCropper();
    }
    function onCropperUp(){ cropper.mode='none'; cropper.hit=''; }

    // ====== è‡ªè¨‚é…è‰²æ§åˆ¶ ======
    function syncCustomColors() {
      document.getElementById('headerC1').value = customColors.headerC1;
      document.getElementById('headerC2').value = customColors.headerC2;
      document.getElementById('headerC3').value = customColors.headerC3;
      document.getElementById('agendaBg').value = customColors.agendaBg;
      document.getElementById('agendaBorder').value = customColors.agendaBorder;
      document.getElementById('agendaAccent').value = customColors.agendaAccent;
      document.getElementById('bgC1').value = customColors.bgC1;
      document.getElementById('bgC2').value = customColors.bgC2;
      document.getElementById('bgGradientDir').value = customColors.bgGradientDir;
    }

    function applyCustomColors() {
      customColors.headerC1 = document.getElementById('headerC1').value;
      customColors.headerC2 = document.getElementById('headerC2').value;
      customColors.headerC3 = document.getElementById('headerC3').value;
      customColors.agendaBg = document.getElementById('agendaBg').value;
      customColors.agendaBorder = document.getElementById('agendaBorder').value;
      customColors.agendaAccent = document.getElementById('agendaAccent').value;
      customColors.bgC1 = document.getElementById('bgC1').value;
      customColors.bgC2 = document.getElementById('bgC2').value;
      customColors.bgGradientDir = document.getElementById('bgGradientDir').value;
      
      if (currentColorScheme === 'custom') {
        updatePoster();
      }
    }

    function toggleCustomSection(show) {
      const section = document.getElementById('customColorsSection');
      if (show) {
        section.classList.add('show');
        syncCustomColors();
      } else {
        section.classList.remove('show');
      }
    }

    // ====== äº‹ä»¶/UI ç¶å®š ======
    function initUI(){
      // åˆ†é åˆ‡æ›ï¼ˆæ‡¶äººç‰ˆï¼‰
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.onclick = function(){
          document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
          this.classList.add('active');
          document.getElementById(this.dataset.tab).classList.add('active');
        };
      });
    
      // æœƒè­°åŸºæœ¬
      document.querySelectorAll('.template-btn').forEach(btn=> btn.onclick=function(){ document.querySelectorAll('.template-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active'); const t=this.dataset.template; if(t!==currentTemplate){ currentTemplate=t; document.getElementById('conferenceSubtitle').value=`${templates[currentTemplate].title}æ²»ç™‚æ–°é€²å±•è«–å£‡`; agendaItems=[...templates[currentTemplate].sampleItems]; refreshAgendaList(); updatePoster(); } else { updatePoster(); } });
      
      document.getElementById('colorScheme').onchange = (e)=>{ 
        currentColorScheme=e.target.value; 
        toggleCustomSection(currentColorScheme === 'custom');
        updatePoster(); 
      };
      
      document.getElementById('gradientDir').onchange = (e)=>{ currentGradientDirection=e.target.value; updatePoster(); };
      
      // è‡ªè¨‚é…è‰²æ§åˆ¶
      document.getElementById('applyCustomColors').onclick = applyCustomColors;

      // è­°ç¨‹ï¼ˆåŒ…å«ä¸»æŒäººæ¬„ä½ï¼Œæ”¹ç‚ºæ”¯æ´å¤šè¡Œï¼‰
      document.getElementById('agendaAdd').onclick = ()=>{ 
        const time=document.getElementById('agendaTime').value.trim(), 
              topic=document.getElementById('agendaTopic').value.trim(), 
              speaker=document.getElementById('agendaSpeaker').value.trim(),
              moderator=document.getElementById('agendaModerator').value.trim(); // æ–°å¢ä¸»æŒäººæ¬„ä½
        
        if(!time||!topic){ 
          [document.getElementById('agendaTime'),document.getElementById('agendaTopic')].forEach(i=>{ 
            if(!i.value) { 
              i.style.borderColor='#dc3545'; 
              setTimeout(()=> i.style.borderColor='#e0e0e0',1200); 
            } 
          }); 
          return; 
        }
        
        if(document.getElementById('agendaAdd').dataset.edit){ 
          const i=parseInt(document.getElementById('agendaAdd').dataset.edit); 
          agendaItems[i]={time,topic,speaker,moderator}; // åŒ…å«ä¸»æŒäºº
          document.getElementById('agendaAdd').textContent='â• æ–°å¢'; 
          delete document.getElementById('agendaAdd').dataset.edit; 
        } else { 
          agendaItems.push({time,topic,speaker,moderator}); // åŒ…å«ä¸»æŒäºº
        }
        
        document.getElementById('agendaTime').value=document.getElementById('agendaTopic').value=document.getElementById('agendaSpeaker').value=document.getElementById('agendaModerator').value=''; // æ¸…ç©ºä¸»æŒäººæ¬„ä½
        refreshAgendaList(); 
        updatePoster(); 
      };
      
      document.getElementById('agendaSample').onclick = ()=>{ agendaItems=[...templates[currentTemplate].sampleItems]; refreshAgendaList(); updatePoster(); };
      document.getElementById('agendaClear').onclick = ()=>{ agendaItems=[]; refreshAgendaList(); updatePoster(); };

      // PNG æª”ä¸Šå‚³
      document.getElementById('overlayFile').addEventListener('change', e=>{ const files=[...e.target.files]; files.forEach(f=>{ const reader=new FileReader(); reader.onload=()=>{ const img=new Image(); img.onload=()=> newOverlayFromImage(img, f.name, reader.result); img.src=reader.result; }; reader.readAsDataURL(f); }); e.target.value=''; });

      // å±¤ç´šæ§åˆ¶
      document.getElementById('bringFront').onclick = ()=>{ if(selectedOverlayIndex<0) return; const ov=overlays.splice(selectedOverlayIndex,1)[0]; overlays.push(ov); selectedOverlayIndex=overlays.length-1; refreshOverlayList(); updatePoster(); };
      document.getElementById('bringForward').onclick = ()=>{ if(selectedOverlayIndex<0) return; const i=selectedOverlayIndex; if(i<overlays.length-1){ [overlays[i],overlays[i+1]]=[overlays[i+1],overlays[i]]; selectedOverlayIndex=i+1; refreshOverlayList(); updatePoster(); } };
      document.getElementById('sendBackward').onclick = ()=>{ if(selectedOverlayIndex<0) return; const i=selectedOverlayIndex; if(i>0){ [overlays[i],overlays[i-1]]=[overlays[i-1],overlays[i]]; selectedOverlayIndex=i-1; refreshOverlayList(); updatePoster(); } };
      document.getElementById('sendBack').onclick = ()=>{ if(selectedOverlayIndex<0) return; const ov=overlays.splice(selectedOverlayIndex,1)[0]; overlays.unshift(ov); selectedOverlayIndex=0; refreshOverlayList(); updatePoster(); };

      // é¸ä¸­åœ–å±¤å±¬æ€§
      document.getElementById('overlayOpacity').oninput = (e)=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; ov.opacity=parseFloat(e.target.value||'1'); updatePoster(); };
      document.getElementById('overlayVisible').onchange = (e)=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; ov.visible=e.target.checked; refreshOverlayList(); updatePoster(); };
      document.getElementById('overlayLockAspect').onchange = (e)=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; ov.lockAspect=e.target.checked; if(ov.lockAspect){ // å°é½Š scaleY åˆ° scaleX
          ov.scaleY = ov.scaleX; updatePoster(); }
      };
      document.getElementById('centerOverlay').onclick = ()=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; const c=getCanvas(); ov.x=c.width/2; ov.y=c.height/2; updatePoster(); };
      document.getElementById('resetOverlay').onclick = ()=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; const c=getCanvas(); ov.scaleX = Math.max(0.05, (c.width*0.4)/ov.w); ov.scaleY = ov.lockAspect ? ov.scaleX : Math.max(0.05, (c.width*0.4)/ov.w); ov.rotation=0; updatePoster(); };
      document.getElementById('removeOverlay').onclick = ()=>{ if(selectedOverlayIndex<0) return; if(confirm('ç§»é™¤ç›®å‰ PNG åœ–å±¤ï¼Ÿ')){ overlays.splice(selectedOverlayIndex,1); if(selectedOverlayIndex>=overlays.length) selectedOverlayIndex=overlays.length-1; refreshOverlayList(); syncOverlayControls(); updatePoster(); } };

      // è£åˆ‡
      document.getElementById('openCropper').onclick = openCropper; document.getElementById('closeCropper').onclick = closeCropper; document.getElementById('resetCropper').onclick = resetCropper; document.getElementById('applyCropper').onclick = ()=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; const r=cropper.rect; // æœ€å°å€¼ä¿è­·
        ov.crop = { x:Math.round(r.x), y:Math.round(r.y), w:Math.round(Math.max(1,r.w)), h:Math.round(Math.max(1,r.h)) }; closeCropper(); updatePoster(); };
      document.getElementById('resetCrop').onclick = ()=>{ const ov=overlays[selectedOverlayIndex]; if(!ov) return; ov.crop={x:0,y:0,w:ov.w,h:ov.h}; updatePoster(); };

      // ä½œåœ–æ§åˆ¶
      document.getElementById('btnUpdate').onclick = updatePoster; document.getElementById('btnDownload').onclick = downloadPoster;
    }

    function bindCropperInteractions(){ const cvs=document.getElementById('cropperCanvas'); cvs.addEventListener('pointerdown', (e)=>{ const rect=cvs.getBoundingClientRect(); const px=e.clientX-rect.left, py=e.clientY-rect.top; const res=hitCropper(px,py); cropper.mode=res.hit; cropper.hit=res.name||''; cropper.start={x:px,y:py}; });
      cvs.addEventListener('pointermove', onCropperMove); cvs.addEventListener('pointerup', onCropperUp); cvs.addEventListener('pointercancel', onCropperUp);
    }

    function exportState() {
      const state = {
        conference: {
          title: document.getElementById('conferenceTitle').value,
          subtitle: document.getElementById('conferenceSubtitle').value,
          date: document.getElementById('conferenceDate').value,
          location: document.getElementById('conferenceLocation').value
        },
        template: currentTemplate,
        colorScheme: currentColorScheme,
        gradientDir: currentGradientDirection,
        customColors,
        agendaItems,
        overlays: overlays.map(ov => ({
          ...ov,
          img: undefined, // åœ–ç‰‡ç‰©ä»¶ä¸å­˜ï¼Œåªå­˜ dataURL
          src: ov.src
        })),
        footer: {
          show: document.getElementById('showFooterNote').checked,
          content: document.getElementById('footerNoteContent').value
        }
      };

      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `poster_state_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function importState() {
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = 'application/json';
      inp.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const state = JSON.parse(reader.result);

            // å¥—ç”¨æœƒè­°è³‡è¨Š
            document.getElementById('conferenceTitle').value = state.conference.title || '';
            document.getElementById('conferenceSubtitle').value = state.conference.subtitle || '';
            document.getElementById('conferenceDate').value = state.conference.date || '';
            document.getElementById('conferenceLocation').value = state.conference.location || '';

            currentTemplate = state.template || 'lung';
            currentColorScheme = state.colorScheme || 'medical_green';
            currentGradientDirection = state.gradientDir || 'horizontal';
            customColors = state.customColors || customColors;

            agendaItems = state.agendaItems || [];
            refreshAgendaList();

            overlays = [];
            if (state.overlays) {
              state.overlays.forEach(ov => {
                const img = new Image();
                img.onload = ()=> updatePoster();
                img.src = ov.src;
                overlays.push({...ov, img});
              });
            }

            document.getElementById('showFooterNote').checked = state.footer?.show ?? true;
            document.getElementById('footerNoteContent').value = state.footer?.content || '';

            updatePoster();
            alert('âœ… ç‹€æ…‹å·²æˆåŠŸåŒ¯å…¥');
          } catch (err) {
            alert('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
          }
        };
        reader.readAsText(file);
      };
      inp.click();
    }

    // ====== åˆå§‹åŒ– ======
    window.onload = function(){ const today=new Date(); const y=today.getFullYear(), m=today.getMonth()+1, d=today.getDate(); document.getElementById('conferenceDate').value=`${y}å¹´${m}æœˆ${d}æ—¥`; document.getElementById('conferenceTitle').value=`${y}å¹´åº¦ç™Œç—‡é†«å­¸æœƒè­°`;
      agendaItems=[...templates[currentTemplate].sampleItems]; refreshAgendaList(); bindCanvasInteractions(); initUI(); bindCropperInteractions(); updatePoster();
      document.getElementById('showFooterNote').addEventListener('change', updatePoster); let t=null; document.getElementById('footerNoteContent').addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(updatePoster, 250); }); 
      
      // åˆå§‹éš±è—è‡ªè¨‚é…è‰²å€å¡Š
      toggleCustomSection(false);
    };
  </script>
</body>
</html>
